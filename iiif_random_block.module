<?php

/**
 * @file
 * Primary module file for the IIIF Random Block module.
 */

use Drupal\Core\Database\Database;

/**
 * Helper function to select a canvas based on defined rules.
 *
 * @param array $canvases
 * The array of canvases from the manifest.
 * @param string $rules_string
 * The rules defined in the settings form.
 *
 * @return array|null
 * The selected canvas array, or null if none could be selected.
 */
function _iiif_random_block_get_canvas_by_rules(array $canvases, string $rules_string): ?array {
  $canvas_count = count($canvases);
  if ($canvas_count === 0) {
    return NULL;
  }

  $rules = preg_split('/\\r\\n|\\r|\\n/', $rules_string, -1, PREG_SPLIT_NO_EMPTY);
  $selected_index = -1;
  $rule_condition_was_met = FALSE;

  foreach ($rules as $rule) {
    if (strpos($rule, '=>') === false) {
      continue;
    }
    [$condition, $action] = array_map('trim', explode('=>', $rule, 2));

    // Check if the condition for this rule matches the canvas count.
    $condition_met = FALSE;
    if (strpos($condition, '+') !== false) {
      $min = (int) $condition;
      if ($canvas_count >= $min) {
        $condition_met = TRUE;
      }
    }
    elseif (strpos($condition, '-') !== false) {
      [$min, $max] = array_map('intval', explode('-', $condition));
      if ($canvas_count >= $min && $canvas_count <= $max) {
        $condition_met = TRUE;
      }
    }
    else {
      if ($canvas_count == (int) $condition) {
        $condition_met = TRUE;
      }
    }

    if ($condition_met) {
      // A rule's condition has matched. We will not use the final fallback.
      $rule_condition_was_met = TRUE;
      $action = strtolower($action);

      if ($action === 'last') {
        $selected_index = $canvas_count - 1;
      }
      elseif (strpos($action, 'random') !== false) {
        preg_match('/random\((\d+)-(\d+|last)(-(\d+))?\)/', $action, $matches);

        $rand_min = 0;
        $rand_max = $canvas_count - 1;

        if (!empty($matches)) {
          $rand_min = (int) $matches[1] - 1;
          $end_val = $matches[2];
          $offset = isset($matches[4]) ? (int) $matches[4] : 0;

          if ($end_val === 'last') {
            $rand_max = $canvas_count - 1 - $offset;
          }
          else {
            $rand_max = (int) $end_val - 1;
          }
        }

        $rand_min = max(0, $rand_min);
        $rand_max = min($canvas_count - 1, $rand_max);

        // Only select if the range is valid.
        if ($rand_min <= $rand_max) {
          $selected_index = mt_rand($rand_min, $rand_max);
        }
        // If the range is invalid, $selected_index remains -1.
      }
      else {
        $selected_index = (int) $action - 1;
      }

      // The first matching rule wins, so we exit the loop.
      break;
    }
  }

  // Fallback to random(all) ONLY if no rule condition was ever met.
  if (!$rule_condition_was_met) {
    $selected_index = mt_rand(0, $canvas_count - 1);
  }

  // Final check for a valid index before returning.
  if ($selected_index < 0 || $selected_index >= $canvas_count) {
    // This can happen if a rule's condition matched, but its action was
    // impossible (e.g., "5 => 10" or "random(3-2)"). In this case,
    // we return NULL to signal that no valid selection could be made.
    return NULL;
  }

  return $canvases[$selected_index] ?? NULL;
}


/**
 * Implements hook_cron().
 */
function iiif_random_block_cron() {
  $database = \Drupal::database();
  $client_factory = \Drupal::service('http_client_factory');
  $logger = \Drupal::logger('iiif_random_block');
  $state = \Drupal::state();
  $time = \Drupal::time();
  $config = \Drupal::config('iiif_random_block.settings');

  $cron_interval = $config->get('cron_interval') ?: 86400;
  $last_run = $state->get('iiif_random_block.last_cron_run', 0);
  if (($time->getRequestTime() - $last_run) < $cron_interval) {
    return;
  }

  $logger->info('Cron job started: Selecting new IIIF images for the block.');

  $number_of_images = $config->get('number_of_images') ?: 5;
  $image_size = $config->get('image_size') ?: 800;
  $selection_rules = $config->get('selection_rules') ?: '';

  $query = $database->select('iiif_manifest_urls', 'm')->fields('m', ['url'])->orderRandom()->range(0, $number_of_images);
  $manifest_urls = $query->execute()->fetchCol();

  if (count($manifest_urls) < $number_of_images) {
    $logger->warning('Could not retrieve @num random manifests.', ['@num' => $number_of_images]);
    return;
  }

  $display_data = [];
  $client = $client_factory->fromOptions(['timeout' => 20]);

  foreach ($manifest_urls as $manifest_url) {
    try {
      $response = $client->get($manifest_url);
      $manifest = json_decode((string) $response->getBody(), TRUE);
      if (json_last_error() !== JSON_ERROR_NONE) {
        throw new \Exception('Invalid JSON');
      }

      $context = $manifest['@context'] ?? '';
      $is_v3 = is_string($context) && strpos($context, 'presentation/3') !== false;
      $canvases = $is_v3 ? ($manifest['items'] ?? []) : ($manifest['sequences'][0]['canvases'] ?? []);

      $selected_canvas = _iiif_random_block_get_canvas_by_rules($canvases, $selection_rules);

      if (!$selected_canvas) {
        $logger->warning('Could not select a canvas for manifest @url.', ['@url' => $manifest_url]);
        continue;
      }

      $image_service = NULL;
      if ($is_v3) {
        if (isset($selected_canvas['items'][0]['items'][0]['body']['service'])) {
          foreach ($selected_canvas['items'][0]['items'][0]['body']['service'] as $service) {
            if (isset($service['type']) && $service['type'] === 'ImageService3') {
              $image_service = $service['id'] ?? $service['@id'] ?? NULL;
              break;
            }
          }
        }
      }
      else {
        $image_service = $selected_canvas['images'][0]['resource']['service']['@id'] ?? NULL;
      }

      if (!$image_service) {
        $logger->warning('Image service URL not found in selected canvas for manifest @url.', ['@url' => $manifest_url]);
        continue;
      }

      $related_url = $manifest['related']['@id'] ?? $manifest['homepage'][0]['id'] ?? '#';
      $label = $manifest['label']['@value'] ?? $manifest['label']['none'][0] ?? (is_string($manifest['label']) ? $manifest['label'] : 'Untitled');

      $display_data[] = [
        'image_url' => rtrim($image_service, '/') . "/full/!{$image_size},{$image_size}/0/default.jpg",
        'manifest_url' => $manifest_url,
        'related_url' => $related_url,
        'label' => mb_substr($label, 0, 512),
      ];
    }
    catch (\Exception $e) {
      $logger->error('Failed to process manifest @url: @message', ['@url' => $manifest_url, '@message' => $e->getMessage()]);
    }
  }

  if (!empty($display_data)) {
    $transaction = $database->startTransaction();
    try {
      $database->truncate('iiif_display_images')->execute();
      $query = $database->insert('iiif_display_images')->fields(['image_url', 'manifest_url', 'related_url', 'label']);
      foreach ($display_data as $item) {
        $query->values($item);
      }
      $query->execute();
      $logger->info('Successfully updated display images table with @count items.', ['@count' => count($display_data)]);
    }
    catch (\Exception $e) {
      $transaction->rollBack();
      $logger->error('Failed to save display images to database: @message', ['@message' => $e->getMessage()]);
    }
  }

  $state->set('iiif_random_block.last_cron_run', $time->getRequestTime());
  $logger->info('Cron job finished.');
}

/**
 * Implements hook_theme().
 */
function iiif_random_block_theme($existing, $type, $theme, $path) {
  return [
    'iiif_random_block' => [
      'variables' => [
        'items' => [],
        'source_link_text' => '',
        'source_link' => '',
      ],
    ],
  ];
}
